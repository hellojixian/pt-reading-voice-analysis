# PT Reading Voice Analysis - Server API Documentation

## Table of Contents
- [Overview](#overview)
- [Base URL](#base-url)
- [API Endpoints](#api-endpoints)
  - [Health Check](#health-check)
  - [Voice Services](#voice-services)
  - [Chat Services](#chat-services)
  - [Assistant Services](#assistant-services)
- [Error Handling](#error-handling)
- [Content Moderation](#content-moderation)

## Overview

PT Reading Voice Analysis provides various API services, including speech-to-text, text-to-speech, basic chat functionality, and advanced conversation features based on OpenAI Assistant. This document describes all available API endpoints, request formats, and response structures.

## Base URL

All API paths are based on the following base URL:
```
http://localhost:8000
```

## API Endpoints

### Health Check

#### Get System Health Status

```
GET /api/health
```

Checks if the service is running properly.

**Response Example:**
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "message": "Service is running normally"
}
```

### Voice Services

#### Speech-to-Text

```
POST /api/speech-to-text
```

Converts an audio file to text.

**Request Parameters:**
- `audio`: Audio file (form data)

**Supported Audio Formats:**
- MP3 (.mp3)
- WAV (.wav)
- OGG (.ogg)
- WebM (.webm)

**Response Example:**
```json
{
  "text": "This is the transcribed text content from the audio"
}
```

#### Text-to-Speech

```
POST /api/text-to-speech
```

Converts text to speech and returns an audio URL.

**Request Parameters:**
- `text`: Text content to convert to speech
- `voice` (optional): Voice type, default is "alloy"

**Available Voice Types:**
- alloy
- echo
- fable
- onyx
- nova
- shimmer

**Request Example:**
```json
{
  "text": "Hello, world!",
  "voice": "nova"
}
```

**Response Example:**
```json
{
  "audio_url": "/api/audio/abc123.mp3"
}
```

#### Get Audio File

```
GET /api/audio/{filename}
```

Retrieves an audio file generated by the text-to-speech function.

**Path Parameters:**
- `filename`: Audio filename

**Response:**
- Audio file (MIME type: audio/mpeg)

### Chat Services

#### Send Chat Message

```
POST /api/chat
```

Sends a message and receives an AI response.

**Request Parameters:**
- `message`: User message content
- `language` (optional): Language code, "en" or "zh", default is "en"

**Request Example:**
```json
{
  "message": "Hello, who am I?",
  "language": "en"
}
```

**Response Example:**
```json
{
  "text": "Hello! You are a user, and I am an AI assistant.",
  "audio_url": "/api/audio/abc123.mp3"
}
```

#### Reset Chat History

```
POST /api/chat/reset
```

Clears the current chat history.

**Response Example:**
```json
{
  "status": "success",
  "message": "Chat history has been reset"
}
```

### Assistant Services

The Assistant services are based on OpenAI's Assistant API, providing more advanced conversation capabilities, including book recommendations, book search, etc.

#### Send Assistant Chat Message

```
POST /api/assistant-chat
```

Sends a message to OpenAI Assistant and receives a response.

**Request Parameters:**
- `message`: User message content
- `language` (optional): Language code, "en" or "zh", default is "en"

**Request Example:**
```json
{
  "message": "Please recommend some adventure books",
  "language": "en"
}
```

**Response Example:**
```json
{
  "text": "Here are some adventure books recommendations...",
  "audio_url": "/api/audio/abc123.mp3",
  "function_results": [
    {
      "name": "recommend_books",
      "arguments": {
        "user_interests": "adventure novels"
      },
      "result": {
        "status": "success",
        "recommended_books": [
          {
            "book_id": "12345",
            "book_title": "Twenty Thousand Leagues Under the Sea",
            "reason": "This is a classic adventure novel"
          }
        ]
      }
    }
  ]
}
```

#### Streaming Assistant Chat

```
GET /api/assistant-chat-stream?message={message}&language={language}
```

Receives Assistant responses as a Server-Sent Events (SSE) stream, suitable for real-time UI updates.

**Query Parameters:**
- `message`: User message content (URL encoded)
- `language` (optional): Language code, "en" or "zh", default is "en"

**Response:**
Server-Sent Events (SSE) stream containing the following event types:
- `status`: Processing status updates
- `progress`: Progress updates (e.g., function call process)
- `complete`: Completed response
- `error`: Error messages

**Event Examples:**
```
event: status
data: {"status": "Thinking..."}

event: progress
data: {"status": "Processing book_recommendation...", "progress": {"type": "book_recommendation", "icon": "ðŸ“š"}}

event: complete
data: {"text": "Here are some adventure books recommendations...", "audio_url": "/api/audio/abc123.mp3", "function_results": [...]}
```

## Assistant Functions

The Assistant API supports the following special functions:

### Book Recommendations

Recommends books based on user interests. When a user asks for book recommendations, the system analyzes user interests and recommends relevant books.

### Book Search

Searches for books by title. When a user mentions a specific book title, the system searches for matching books and provides information.

### Book Content Retrieval

Retrieves detailed content of a specific book. When a user wants to discuss a book, the system retrieves the content of that book and can answer related questions.

## Error Handling

All API endpoints return standard JSON error responses in case of errors:

```json
{
  "error": "Error message description"
}
```

Common HTTP status codes:
- 200 OK: Request successful
- 400 Bad Request: Invalid request parameters
- 500 Internal Server Error: Server internal error

## Content Moderation

All text content (including user input and AI responses) goes through content moderation to ensure the content is suitable for children. If inappropriate content is detected, the system returns a friendly warning message instead of the original response:

```json
{
  "text": "This topic is not suitable for your age...",
  "is_warning": true,
  "audio_url": "/api/audio/abc123.mp3"
}
